<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å­¸ç¿’å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 28px;
        }
        
        /* è¼¸å…¥å€åŸŸ */
        .input-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 10px;
            font-family: inherit;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: #48bb78;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-danger {
            background: #f56565;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .btn-secondary {
            background: #718096;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        /* æ–‡å­—è™•ç†å€åŸŸ */
        #displayArea {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            min-height: 100px;
            line-height: 2;
            font-size: 18px;
            display: none;
        }
        
        /* å–®å­—å¯é»æ“Šæ¨£å¼ï¼ˆä¿ç•™ä½ çš„é‚è¼¯ï¼Œæ”¹ç”¨ spanï¼‰ */
        .word {
            cursor: pointer;
            padding: 3px 5px;
            border-radius: 5px;
            transition: all 0.2s;
            display: inline-block;
        }
        
        .word:hover {
            background: #e6f2ff;
        }
        
        .word.selected {
            background: #ffd700;
            font-weight: bold;
            color: #333;
        }
        
        /* å·²é¸å–®å­—è¨ˆæ•¸ */
        .selected-count {
            background: #e6fffa;
            color: #234e52;
            padding: 12px 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
            font-weight: 500;
        }
        
        /* å·¥å…·åˆ—ï¼ˆä¿ç•™ä½ çš„æ‰€æœ‰åŠŸèƒ½ï¼‰ */
        .toolbar {
            background: #f7fafc;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        
        .toolbar label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .toolbar input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .divider {
            color: #cbd5e0;
            margin: 0 5px;
        }
        
        /* å–®å­—åˆ—è¡¨ï¼ˆä¿ç•™ä½ çš„ checkbox è¨­è¨ˆï¼‰ */
        .word-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.2s;
        }
        
        .word-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .word-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .word-item-header input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .word-item-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .word-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        
        .word-tag {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .context-text {
            color: #4a5568;
            line-height: 1.6;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .meta-info {
            color: #718096;
            font-size: 13px;
            margin-top: 8px;
        }
        
        .empty-state {
            text-align: center;
            color: #a0aec0;
            padding: 40px;
            font-size: 16px;
        }
        
        /* æ‰‹æ©Ÿå„ªåŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š è‹±æ–‡å­¸ç¿’å·¥å…·</h1>
        
        <!-- è¼¸å…¥å€åŸŸ -->
        <div class="input-section">
            <textarea id="articleInput" placeholder="è²¼ä¸Šè‹±æ–‡æ–‡ç« ..."></textarea>
            <input type="text" id="sourceInput" placeholder="ä¾†æºï¼šå¦‚ Redditã€Chapter 3">
            <button class="btn" onclick="processText()">ğŸ”„ è™•ç†æ–‡å­—</button>
            <button class="btn btn-danger" onclick="clearInput()">ğŸ—‘ï¸ æ¸…é™¤è¼¸å…¥</button>
        </div>
        
        <!-- å¯é»æ“Šçš„æ–‡å­—é¡¯ç¤ºå€ -->
        <div id="displayArea"></div>
        
        <!-- å·²é¸å–®å­—è¨ˆæ•¸ -->
        <div class="selected-count" id="selectedCount"></div>
        
        <!-- å„²å­˜æŒ‰éˆ• -->
        <button class="btn btn-success" id="saveButton" onclick="saveSelection()" style="display: none;">ğŸ’¾ å„²å­˜é¸å–çš„å–®å­—</button>
        
        <!-- å·¥å…·åˆ—ï¼ˆä¿ç•™ä½ æ‰€æœ‰çš„åŠŸèƒ½ï¼‰ -->
        <div class="toolbar">
            <strong>ğŸ’© å–®å­—åˆ—è¡¨ï¼š</strong>
            <label>
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                å…¨é¸
            </label>
            <label>
                <input type="checkbox" id="displayContext" onchange="displayWords()">
                é¡¯ç¤ºä¸Šä¸‹æ–‡
            </label>
            <button class="btn btn-danger" id="deleteButton" onclick="deleteSelected()" style="display: none;">åˆªé™¤é¸å–</button>
            <span class="divider">|</span>
            <button class="btn btn-secondary" onclick="sortWords('word')">å–®å­—æ’åº</button>
            <button class="btn btn-secondary" onclick="sortWords('sentence')">å¥å­æ’åº</button>
            <button class="btn btn-secondary" onclick="sortWords('date')">æ—¥æœŸæ’åº</button>
            <span class="divider">|</span>
            <button class="btn btn-secondary" onclick="exportData()">åŒ¯å‡º</button>
            <button class="btn btn-secondary" onclick="importData()">åŒ¯å…¥</button>
        </div>
        
        <!-- å–®å­—åˆ—è¡¨ -->
        <div id="wordList"></div>
    </div>

    <script>
        // ====== å…¨åŸŸè®Šæ•¸ ======
        let selectedWords = new Set(); // ç”¨ Set å„²å­˜é¸ä¸­çš„å–®å­—ï¼ˆä¸é‡è¤‡ï¼‰
        let currentSort = { key: 'date', order: 'desc' }; // é è¨­æŒ‰æ—¥æœŸé™åº

        // ====== è™•ç†æ–‡å­—ï¼šæŠŠå¥å­æ‹†æˆå¯é»æ“Šçš„å–®å­— ======
        function processText() {
            const text = document.getElementById('articleInput').value.trim();
            if (!text) {
                //alert('è«‹å…ˆè¼¸å…¥æ–‡å­—ï¼');
                return;
            }

            const displayArea = document.getElementById('displayArea');
            selectedWords.clear(); // æ¸…ç©ºä¹‹å‰é¸çš„å–®å­—
            
            // ç”¨æ­£å‰‡è¡¨é”å¼åˆ†å‰²ï¼šå–®å­—ï¼ˆåŒ…å« apostropheï¼‰å’Œæ¨™é»ç¬¦è™Ÿ
            const tokens = text.match(/\b[\w']+\b|[^\w\s]/g) || [];
            
            let html = '';
            tokens.forEach((token, index) => {
                if (/\b[\w']+\b/.test(token)) {
                    // æ˜¯å–®å­— â†’ åŒ…æˆå¯é»æ“Šçš„ span
                    html += `<span class="word" onclick="toggleWord(this)">${token}</span>`;
                } else {
                    // æ˜¯æ¨™é»ç¬¦è™Ÿ â†’ ç›´æ¥é¡¯ç¤º
                    html += token;
                }
                
                // å–®å­—å¾Œé¢åŠ ç©ºæ ¼ï¼ˆé™¤éä¸‹ä¸€å€‹æ˜¯æ¨™é»ï¼‰
                if (index < tokens.length - 1 && /\b[\w']+\b/.test(token)) {
                    const nextToken = tokens[index + 1];
                    if (/\b[\w']+\b/.test(nextToken)) {
                        html += ' ';
                    }
                }
            });
            
            displayArea.innerHTML = html;
            displayArea.style.display = 'block';
            updateSelectedCount();
        }

        // ====== é»æ“Šå–®å­—ï¼šæ™ºæ…§é¸å–ï¼ˆæ”¯æ´ç‰‡èªï¼‰ ======
        function toggleWord(element) {
            if (element.classList.contains('selected')) {
                // å–æ¶ˆé¸å–
                element.classList.remove('selected');
                // é‡æ–°è¨ˆç®—æ‰€æœ‰ç‰‡èª
                rebuildPhrases();
            } else {
                // é¸å–
                element.classList.add('selected');
                // é‡æ–°è¨ˆç®—æ‰€æœ‰ç‰‡èª
                rebuildPhrases();
            }
            
            updateSelectedCount();
        }

        // é‡æ–°è¨ˆç®—æ‰€æœ‰ç‰‡èªï¼šæŠŠç›¸é„°çš„é¸ä¸­å–®å­—çµ„æˆç‰‡èª
        function rebuildPhrases() {
            selectedWords.clear();
            
            const allWords = Array.from(document.querySelectorAll('.word'));
            let i = 0;
            
            while (i < allWords.length) {
                if (allWords[i].classList.contains('selected')) {
                    // æ‰¾å‡ºé€£çºŒé¸ä¸­çš„å–®å­—
                    const phraseWords = [];
                    while (i < allWords.length && allWords[i].classList.contains('selected')) {
                        phraseWords.push(allWords[i].textContent);
                        i++;
                    }
                    // çµ„æˆç‰‡èªæˆ–å–®å­—
                    const phrase = phraseWords.join(' ');
                    selectedWords.add(phrase);
                } else {
                    i++;
                }
            }
        }

        // ====== æ›´æ–°å·²é¸å–®å­—è¨ˆæ•¸ ======
        function updateSelectedCount() {
            const countDiv = document.getElementById('selectedCount');
            const saveBtn = document.getElementById('saveButton');
            
            if (selectedWords.size > 0) {
                countDiv.textContent = `å·²é¸æ“‡ ${selectedWords.size} å€‹å–®å­—ï¼š${Array.from(selectedWords).join(', ')}`;
                countDiv.style.display = 'block';
                saveBtn.style.display = 'inline-block';
            } else {
                countDiv.style.display = 'none';
                saveBtn.style.display = 'none';
            }
        }

        // ====== å„²å­˜é¸å–çš„å–®å­—ï¼ˆå„²å­˜å¾Œå–æ¶ˆé¸å–ï¼‰ ======
        function saveSelection() {
            if (selectedWords.size === 0) {
                //alert('è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹å–®å­—ï¼');
                return;
            }

            const sentence = document.getElementById('articleInput').value.trim();
            const source = document.getElementById('sourceInput').value.trim() || 'unknown';
            const words = Array.from(selectedWords);
            
            // å¾ localStorage è®€å–ç¾æœ‰è³‡æ–™
            let items = JSON.parse(localStorage.getItem('words')) || [];
            
            // ã€é‡é»ã€‘æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„å¥å­
            const existingIndex = items.findIndex(item => item.context === sentence);
            
            if (existingIndex !== -1) {
                // å·²å­˜åœ¨ â†’ åˆä½µå–®å­—ï¼ˆä¸é‡è¤‡ï¼‰
                const existingWords = items[existingIndex].words;
                const mergedWords = [...new Set([...existingWords, ...words])];
                items[existingIndex].words = mergedWords;
                items[existingIndex].date = new Date().toISOString(); // æ›´æ–°æ™‚é–“
                //alert(`âœ… å·²å°‡æ–°å–®å­—/ç‰‡èªåˆä½µåˆ°ç¾æœ‰ä¾‹å¥ï¼ï¼ˆå…± ${mergedWords.length} å€‹ï¼‰`);
            } else {
                // ä¸å­˜åœ¨ â†’ æ–°å¢
                items.unshift({
                    context: sentence,
                    words: words,
                    source: source,
                    date: new Date().toISOString()
                });
                //alert('âœ… å„²å­˜æˆåŠŸï¼');
            }

            localStorage.setItem('words', JSON.stringify(items));
            
            // ã€é‡é»ã€‘å„²å­˜å¾Œå–æ¶ˆé¸å–ï¼ˆä½†ä¿ç•™æ–‡å­—å’Œè™•ç†å¾Œçš„é¡¯ç¤ºï¼‰
            document.querySelectorAll('.word.selected').forEach(el => {
                el.classList.remove('selected');
            });
            selectedWords.clear();
            updateSelectedCount();
            displayWords();
        }

        // ====== æ¸…é™¤è¼¸å…¥ ======
        function clearInput() {
            document.getElementById('articleInput').value = '';
            document.getElementById('sourceInput').value = '';
            document.getElementById('displayArea').innerHTML = '';
            document.getElementById('displayArea').style.display = 'none';
            selectedWords.clear();
            updateSelectedCount();
        }

        // ====== é¡¯ç¤ºå–®å­—åˆ—è¡¨ï¼ˆä¿ç•™ä½ çš„ checkbox è¨­è¨ˆï¼‰ ======
        function displayWords() {
            const items = JSON.parse(localStorage.getItem('words')) || [];
            const wordList = document.getElementById('wordList');
            const showContext = document.getElementById('displayContext').checked;

            if (items.length === 0) {
                wordList.innerHTML = '<div class="empty-state">é‚„æ²’æœ‰å„²å­˜ä»»ä½•ä¾‹å¥å–”ï½</div>';
                return;
            }

            let html = '';
            items.forEach((item, index) => {
                // é«˜äº®å–®å­—
                let displayText = item.context;
                if (showContext) {
                    item.words.forEach(word => {
                        const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                        displayText = displayText.replace(regex, '<strong style="background: #ffd700; padding: 2px 4px; border-radius: 3px;">$1</strong>');
                    });
                }

                html += `
                    <div class="word-item">
                        <div class="word-item-header">
                            <input type="checkbox" data-index="${index}" onchange="updateDeleteButton()">
                            <span class="word-item-title">${index}. ${item.words.join(', ')}</span>
                        </div>
                        <div class="word-tags">
                            ${item.words.map(w => `<span class="word-tag">${w}</span>`).join('')}
                        </div>
                        ${showContext ? `<div class="context-text">${displayText}</div>` : ''}
                        <div class="meta-info">
                            ä¾†æº: ${item.source} | å»ºç«‹: ${new Date(item.date).toLocaleString('zh-TW')}
                        </div>
                    </div>
                `;
            });

            wordList.innerHTML = html;
        }

        // ====== å…¨é¸ / å–æ¶ˆå…¨é¸ ======
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#wordList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateDeleteButton();
        }

        // ====== æ›´æ–°åˆªé™¤æŒ‰éˆ•é¡¯ç¤º ======
        function updateDeleteButton() {
            const deleteBtn = document.getElementById('deleteButton');
            const checkedCount = document.querySelectorAll('#wordList input[type="checkbox"]:checked').length;
            deleteBtn.style.display = checkedCount > 0 ? 'inline-block' : 'none';
        }

        // ====== åˆªé™¤é¸å–çš„é …ç›® ======
        function deleteSelected() {
            const checkedIndexes = Array.from(document.querySelectorAll('#wordList input[type="checkbox"]:checked'))
                .map(cb => parseInt(cb.getAttribute('data-index')));
            
            if (checkedIndexes.length === 0) return;
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${checkedIndexes.length} å€‹é …ç›®å—ï¼Ÿ`)) return;

            let items = JSON.parse(localStorage.getItem('words')) || [];
            items = items.filter((_, i) => !checkedIndexes.includes(i));
            localStorage.setItem('words', JSON.stringify(items));
            
            document.getElementById('selectAll').checked = false;
            displayWords();
        }

        // ====== æ’åºï¼ˆä¿ç•™ä½ çš„é‚è¼¯ï¼‰ ======
        function sortWords(sortKey) {
            let items = JSON.parse(localStorage.getItem('words')) || [];
            
            // å¦‚æœé»åŒä¸€å€‹æŒ‰éˆ•ï¼Œå°±åè½‰é †åº
            if (currentSort.key === sortKey) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = sortKey;
                currentSort.order = 'asc';
            }
            
            // æ’åºé‚è¼¯
            if (sortKey === 'date') {
                items.sort((a, b) => {
                    const diff = new Date(a.date) - new Date(b.date);
                    return currentSort.order === 'asc' ? diff : -diff;
                });
            } else if (sortKey === 'word') {
                items.sort((a, b) => {
                    const result = a.words[0].localeCompare(b.words[0]);
                    return currentSort.order === 'asc' ? result : -result;
                });
            } else if (sortKey === 'sentence') {
                items.sort((a, b) => {
                    const result = a.context.localeCompare(b.context);
                    return currentSort.order === 'asc' ? result : -result;
                });
            }
            
            localStorage.setItem('words', JSON.stringify(items));
            displayWords();
        }

        // ====== åŒ¯å‡ºè³‡æ–™ ======
        function exportData() {
            const data = localStorage.getItem('words');
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `words_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ====== åŒ¯å…¥è³‡æ–™ ======
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const data = JSON.parse(event.target.result);
                            localStorage.setItem('words', JSON.stringify(data));
                            displayWords();
                            //alert('âœ… åŒ¯å…¥æˆåŠŸï¼');
                        } catch (err) {
                            //alert('âŒ åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // ====== é é¢è¼‰å…¥æ™‚é¡¯ç¤ºè³‡æ–™ ======
        window.onload = function() {
            displayWords();
        };
    </script>
</body>
</html>